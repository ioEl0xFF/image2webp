# img2webp

DOCX ファイルから画像名を抽出し、WebP 形式に変換する Python ツールです。

## 概要

このツールは、Word 文書（DOCX）内のテーブルから画像名を自動抽出し、対応する画像ファイルを複数のサイズで WebP 形式に変換します。主に Web サイト用の画像最適化に使用されます。

## 主な機能

-   **DOCX 解析**: Word 文書内のテーブルから画像名を自動抽出
-   **画像変換**: JPG、PNG、WebP 形式の画像を WebP 形式に変換
-   **複数サイズ対応**: 設定に基づいて複数のサイズで画像を生成
-   **アスペクト比保持**: 元画像のアスペクト比を保持しながらリサイズ
-   **HTML画像名置き換え**: HTMLファイル内の画像ファイル名を自動的にWebP形式に置き換え
-   **ログ機能**: 詳細な処理ログを出力
-   **バッチ処理**: 複数の DOCX ファイルを一括処理

## ディレクトリ構造

```
img2webp/
├── main.py              # メイン処理
├── config.py            # 設定ファイル
├── docx_parser.py       # DOCX解析モジュール
├── image_utils.py       # 画像処理モジュール
├── docxs/               # 入力DOCXファイル格納ディレクトリ
├── images/              # 元画像ファイル格納ディレクトリ
├── html/                # HTMLファイル格納ディレクトリ
├── output/              # 変換済みWebP画像出力ディレクトリ
└── .logs/               # ログファイル格納ディレクトリ
```

## 必要な環境

-   Python 3.7 以上
-   以下の Python パッケージ:
    -   `python-docx`: DOCX ファイルの読み込み
    -   `Pillow`: 画像処理

## インストール

1. リポジトリをクローン:

```bash
git clone <repository-url>
cd img2webp
```

2. 必要なパッケージをインストール:

```bash
pip install python-docx Pillow
```

## 使用方法

### 基本的な使用方法

1. **入力ファイルの準備**:

    - `docxs/` ディレクトリに処理対象の DOCX ファイルを配置(複数可)
    - `images/` ディレクトリに元画像ファイル（JPG、PNG、WebP）を配置
    - `html/` ディレクトリに画像名置き換え対象のHTMLファイルを配置（オプション）

2. **実行**:

```bash
python main.py
```

### DOCX ファイルの形式

DOCX ファイル内のテーブルで以下の形式で画像名を記述してください:

```
＜画像＞image-name-01
＜画像名＞image-name-02
＜画像1＞image-name-03
＜画像（補足）＞image-name-04
```

-   左セル: コード（例: `COMFRPTC09`、`GSTFRPTA15`）
-   右セル: 画像名を含むテキスト

### 設定

`config.py` で以下の設定を変更できます:

-   **WIDTH_MAP**: コード別の画像サイズ設定
-   **HTML_IMAGE_REPLACE_ORDER**: HTML画像名置き換えの順序設定
-   **SUPPORTED_EXTENSIONS**: 対応する画像形式
-   **WEBP_QUALITY**: WebP の画質設定（0-100）
-   **LOG_LEVEL**: ログレベル

## 出力

### ディレクトリ構造

各 DOCX ファイルごとに以下の構造で出力されます:

```
output/
├── ファイル名1/
│   ├── image-name-011800.webp
│   ├── image-name-011200.webp
│   └── ...
└── ファイル名2/
    ├── image-name-021800.webp
    └── ...
```

### 出力ファイル

-   `.logs/all_image_names.json`: 全ファイルの画像名情報（JSON 形式）
-   `.logs/all_converted_images.txt`: 変換済み画像ファイルの一覧
-   `.logs/LOG.log`: 詳細な処理ログ

## 対応画像形式

### 入力形式

-   JPG/JPEG
-   PNG
-   WebP

### 出力形式

-   WebP（複数サイズ）

## HTML画像名置き換え機能

このツールは、DOCXファイルから抽出した画像名情報を使用して、HTMLファイル内の画像ファイル名を自動的にWebP形式に置き換える機能を提供します。

### 動作概要

1. **HTMLファイル検索**: `html/` ディレクトリ内で、DOCXファイル名と同じ名前のHTMLファイルを検索
2. **画像名抽出**: DOCXファイルから抽出した画像名情報を取得
3. **置き換え実行**: HTMLファイル内の画像ファイル名を、設定された順序でWebP形式に置き換え
4. **ファイル更新**: 置き換え後のHTMLファイルを保存

### 置き換えルール

- **対象ファイル**: `html/` ディレクトリ内のHTMLファイル（DOCXファイル名と同名）
- **置き換え対象**: HTMLファイル内の画像ファイル名（JPG、PNG、WebP等）
- **置き換え後**: 画像名 + サイズ + `.webp` 形式
- **置き換え順序**: `config.py`の`HTML_IMAGE_REPLACE_ORDER`で設定

### 設定例

```python
# HTML画像名置き換えの順序設定
HTML_IMAGE_REPLACE_ORDER = {
    "COMFRPTC09": [1800, 1200, 900, 500, 900, 900],
    "COMFRPTC12": [1200, 900, 500, 900, 500],
    "GSTFRPTA15": [900, 500, 900],
    # ...
}
```

### 置き換え例

**置き換え前のHTML:**
```html
<img src="sample-image-01.jpg" alt="サンプル画像">
<img src="sample-image-02.png" alt="サンプル画像2">
```

**置き換え後のHTML（COMFRPTC09の場合）:**
```html
<img src="sample-image-011800.webp" alt="サンプル画像">
<img src="sample-image-021200.webp" alt="サンプル画像2">
```

## 画像サイズ設定

`config.py`の`WIDTH_MAP`で各コードに対応する画像サイズを設定できます:

```python
WIDTH_MAP = {
    "COMFRPTC09": [[1800, 1200], [1200, 800], [900, 600], [500, 333]],
    "COMFRPTC14": [[800, 800], [600, 600], [400, 400]],
    "GSTFRPTA15": [[900, 0], [500, 0]],  # 高さ0はアスペクト比保持
    # ...
}
```

## ログ機能

-   処理の進行状況を詳細に記録
-   エラーや警告の情報を保存
-   コンソールとファイルの両方に出力

## トラブルシューティング

### よくある問題

1. **画像ファイルが見つからない**

    - `images/` ディレクトリに画像ファイルが存在するか確認
    - ファイル名が正確に一致しているか確認

2. **DOCX ファイルが読み込めない**

    - ファイルが破損していないか確認
    - 一時ファイル（~$で始まるファイル）は自動的に除外されます

3. **変換に失敗する**
    - 画像ファイルが破損していないか確認
    - 対応する画像形式か確認

4. **docxファイルを更新して、再度変換を行いたい場合**
    - outputディレクトリ内の再変換対象フォルダを削除してから再実行すると、スキップされずに変換されます

5. **HTML画像名置き換えが動作しない**
    - `html/` ディレクトリにHTMLファイルが存在するか確認
    - HTMLファイル名がDOCXファイル名（拡張子除く）と一致しているか確認
    - `config.py`の`HTML_IMAGE_REPLACE_ORDER`に対象のコードが定義されているか確認
    - HTMLファイル内の画像ファイル名が、DOCXから抽出された画像名と一致しているか確認

## ライセンス

このプロジェクトのライセンスについては、プロジェクトのライセンスファイルを参照してください。

## 貢献

バグ報告や機能改善の提案は、Issue または Pull Request でお願いします。

## 更新履歴

-   初期バージョン: DOCX 解析と WebP 変換機能を実装
-   ログ機能の追加
-   複数サイズ対応
-   アスペクト比保持機能
-   HTML画像名置き換え機能の追加
